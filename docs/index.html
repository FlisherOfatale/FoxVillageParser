<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Horaire Fantasia</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            margin-bottom: 10px;
            font-size: 2em;
        }

        .header p {
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            background: #ecf0f1;
            border-bottom: 3px solid #3498db;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            background: #ecf0f1;
            border: none;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .tab:hover {
            background: #d5dbdb;
        }

        .tab.active {
            background: #3498db;
            color: white;
        }

        .content {
            padding: 20px;
            min-height: 400px;
        }

        .filter-section {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #3498db;
        }

        .filter-section h3 {
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .filter-controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        select {
            padding: 8px 12px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            font-size: 14px;
            background: white;
        }

        .day-section {
            margin-bottom: 30px;
        }

        .day-header {
            background: linear-gradient(90deg, #e74c3c, #c0392b);
            color: white;
            padding: 15px 20px;
            margin-bottom: 15px;
            border-radius: 5px;
            font-size: 1.3em;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .schedule-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .schedule-table th {
            background: #34495e;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: bold;
        }

        .schedule-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #ecf0f1;
        }

        .schedule-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        .schedule-table tr:hover {
            background: #e8f4f8;
        }

        .time-column {
            font-weight: bold;
            color: #e74c3c;
            width: 80px;
        }

        .rider-column {
            font-weight: bold;
            color: #2c3e50;
        }

        .rider-link {
            color: #2c3e50;
            text-decoration: none;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .rider-link:hover {
            color: #3498db;
            text-decoration: underline;
        }

        .ring-link {
            color: white;
            text-decoration: none;
            cursor: pointer;
            transition: opacity 0.3s ease;
        }

        .ring-link:hover {
            opacity: 0.8;
            text-decoration: underline;
        }

        .class-column {
            color: #7f8c8d;
            max-width: 300px;
        }

        .ring-column {
            color: white;
            text-align: center;
            border-radius: 3px;
            font-weight: bold;
            padding: 4px 8px;
        }

        .print-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .print-btn:hover {
            background: #219a52;
            transform: translateY(-1px);
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
            font-style: italic;
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }

            .tabs, .filter-section, .print-btn {
                display: none !important;
            }

            .container {
                box-shadow: none;
                border-radius: 0;
            }

            .day-header {
                background: #333 !important;
                -webkit-print-color-adjust: exact;
            }

            .day-section {
                page-break-before: always;
                page-break-inside: avoid;
            }

            .day-section:first-child {
                page-break-before: auto;
            }

            .schedule-table {
                page-break-inside: auto;
            }

            .schedule-table tr {
                page-break-inside: avoid;
            }
        }

        @media (max-width: 768px) {
            .tabs {
                flex-direction: column;
            }

            .filter-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .schedule-table {
                font-size: 12px;
            }

            .schedule-table th,
            .schedule-table td {
                padding: 6px;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>Horaire Fantasia</h1>
        <p>Programme complet des épreuves</p>
    </div>

    <div class="tabs">
        <button class="tab active" onclick="showTab('schedule')">Horaire Complet</button>
        <button class="tab" onclick="showTab('riders')">Par Cavalier</button>
        <button class="tab" onclick="showTab('rings')">Par Ring</button>
        <button class="tab" onclick="showTab('days')">Par Jour</button>
    </div>

    <div class="content">
        <!-- Schedule Tab -->
        <div id="schedule-tab" class="tab-content">
            <button class="print-btn" onclick="window.print()">Imprimer</button>
            <div id="full-schedule"></div>
        </div>

        <!-- Riders Tab -->
        <div id="riders-tab" class="tab-content" style="display: none;">
            <div class="filter-section">
                <h3>Filtrer par Cavalier</h3>
                <div class="filter-controls">
                    <select id="rider-filter" onchange="filterByRider()">
                        <option value="">Tous les cavaliers</option>
                    </select>
                    <button class="print-btn" onclick="window.print()">Imprimer</button>
                </div>
            </div>
            <div id="rider-schedule"></div>
        </div>

        <!-- Rings Tab -->
        <div id="rings-tab" class="tab-content" style="display: none;">
            <div class="filter-section">
                <h3>Filtrer par Ring</h3>
                <div class="filter-controls">
                    <select id="ring-filter" onchange="filterByRing()">
                        <option value="">Tous les rings</option>
                    </select>
                    <button class="print-btn" onclick="window.print()">Imprimer</button>
                </div>
            </div>
            <div id="ring-schedule"></div>
        </div>

        <!-- Days Tab -->
        <div id="days-tab" class="tab-content" style="display: none;">
            <div class="filter-section">
                <h3>Filtrer par Jour</h3>
                <div class="filter-controls">
                    <select id="day-filter" onchange="filterByDay()">
                        <option value="">Tous les jours</option>
                        <option value="vendredi">Vendredi</option>
                        <option value="samedi">Samedi</option>
                        <option value="dimanche">Dimanche</option>
                    </select>
                    <button class="print-btn" onclick="window.print()">Imprimer</button>
                </div>
            </div>
            <div id="day-schedule"></div>
        </div>
    </div>
</div>

<script>
    let scheduleData = [];
    let currentTab = 'schedule';

    // Get background color for ring - INLINE STYLES APPROACH
    function getRingColor(ring) {
        console.log('Getting color for ring:', ring);
        if (ring === 'Ring 1') return '#e74c3c'; // Red
        if (ring === 'Ring 2') return '#3498db'; // Blue
        if (ring === 'Ring 3') return '#2ecc71'; // Green
        if (ring === 'Ring 4') return '#f39c12'; // Orange
        if (ring === 'Combiné') return '#9b59b6'; // Purple
        return '#34495e'; // Default gray
    }

    // Handle rider name click
    function handleRiderClick(riderName) {
        // Set the rider filter
        const riderSelect = document.getElementById('rider-filter');
        if (riderSelect) {
            riderSelect.value = riderName;
        }

        // Switch to riders tab and filter
        showTab('riders');
        filterByRider();
    }

    // Handle ring click
    function handleRingClick(ringName) {
        // Set the ring filter
        const ringSelect = document.getElementById('ring-filter');
        if (ringSelect) {
            ringSelect.value = ringName;
        }

        // Switch to rings tab and filter
        showTab('rings');
        filterByRing();
    }

    // Load schedule data with cache busting
    async function loadSchedule() {
        try {
            const timestamp = new Date().getTime();
            const response = await fetch(`./schedule.json?t=${timestamp}`);
            scheduleData = await response.json();

            console.log('Loading real schedule data from schedule.json');
            console.log(`Loaded ${scheduleData.length} entries`);

            // Sort by day and time
            scheduleData.sort((a, b) => {
                const dayOrder = { 'vendredi': 0, 'samedi': 1, 'dimanche': 2 };
                if (a.day.toLowerCase() !== b.day.toLowerCase()) {
                    return dayOrder[a.day.toLowerCase()] - dayOrder[b.day.toLowerCase()];
                }
                return a.time.localeCompare(b.time);
            });

            populateFilters();
            parseUrlParameters();
            showFullSchedule();

        } catch (error) {
            console.error('Erreur lors du chargement:', error);
            document.querySelector('.content').innerHTML = '<div class="no-data">Erreur: Impossible de charger schedule.json</div>';
        }
    }

    // URL parameter functions
    function getUrlParameters() {
        const params = new URLSearchParams(window.location.search);
        return {
            tab: params.get('tab'),
            rider: params.get('rider'),
            day: params.get('day'),
            ring: params.get('ring')
        };
    }

    function updateUrl(params) {
        const url = new URL(window.location);

        // Clear all parameters first
        url.searchParams.delete('tab');
        url.searchParams.delete('rider');
        url.searchParams.delete('day');
        url.searchParams.delete('ring');

        // Add new parameters
        if (params.tab && params.tab !== 'schedule') {
            url.searchParams.set('tab', params.tab);
        }
        if (params.rider) {
            url.searchParams.set('rider', params.rider);
        }
        if (params.day) {
            url.searchParams.set('day', params.day);
        }
        if (params.ring) {
            url.searchParams.set('ring', params.ring);
        }

        window.history.replaceState({}, '', url);
    }

    function parseUrlParameters() {
        const params = getUrlParameters();

        // Set tab
        if (params.tab && ['schedule', 'riders', 'rings', 'days'].includes(params.tab)) {
            showTab(params.tab);
        }

        // Set rider filter
        if (params.rider) {
            const riderSelect = document.getElementById('rider-filter');
            if (riderSelect) {
                riderSelect.value = params.rider;
                showTab('riders');
                filterByRider();
            }
        }

        // Set day filter
        if (params.day && ['vendredi', 'samedi', 'dimanche'].includes(params.day)) {
            const daySelect = document.getElementById('day-filter');
            if (daySelect) {
                daySelect.value = params.day;
                showTab('days');
                filterByDay();
            }
        }

        // Set ring filter
        if (params.ring) {
            const ringSelect = document.getElementById('ring-filter');
            if (ringSelect) {
                ringSelect.value = params.ring;
                showTab('rings');
                filterByRing();
            }
        }

        // If no parameters, show default
        if (!params.tab && !params.rider && !params.day && !params.ring) {
            showTab('schedule');
        }
    }


    // Filter by day with URL updating
    function filterByDay() {
        const selectedDay = document.getElementById('day-filter').value;
        const container = document.getElementById('day-schedule');

        // Update URL
        updateUrl({ tab: 'days', day: selectedDay });

        if (!selectedDay) {
            showFullSchedule();
            container.innerHTML = document.getElementById('full-schedule').innerHTML;
            return;
        }

        const dayData = scheduleData.filter(item => item.day.toLowerCase() === selectedDay);

        if (dayData.length > 0) {
            container.innerHTML = `
                    <div class="day-section">
                        <div class="day-header">${selectedDay.charAt(0).toUpperCase() + selectedDay.slice(1)}</div>
                        ${createScheduleTable(dayData)}
                    </div>
                `;
        } else {
            container.innerHTML = '<div class="no-data">Aucune compétition pour ce jour</div>';
        }
    }

    // Filter by rider with URL updating
    function filterByRider() {
        const selectedRider = document.getElementById('rider-filter').value;
        const container = document.getElementById('rider-schedule');

        // Update URL
        updateUrl({ tab: 'riders', rider: selectedRider });

        if (!selectedRider) {
            container.innerHTML = '<div class="no-data">Sélectionnez un cavalier</div>';
            return;
        }

        const riderData = scheduleData.filter(item => item.rider_name === selectedRider);
        const days = ['vendredi', 'samedi', 'dimanche'];
        let html = '';

        days.forEach(day => {
            const dayData = riderData.filter(item => item.day.toLowerCase() === day);
            if (dayData.length > 0) {
                html += `
                        <div class="day-section">
                            <div class="day-header">${day.charAt(0).toUpperCase() + day.slice(1)} - ${selectedRider}</div>
                            ${createScheduleTable(dayData)}
                        </div>
                    `;
            }
        });

        container.innerHTML = html || '<div class="no-data">Aucune compétition pour ce cavalier</div>';
    }

    // Populate filter dropdowns
    function populateFilters() {
        const riders = [...new Set(scheduleData.map(item => item.rider_name))].sort();
        const rings = [...new Set(scheduleData.map(item => item.ring))].sort();

        const riderSelect = document.getElementById('rider-filter');
        const ringSelect = document.getElementById('ring-filter');

        riders.forEach(rider => {
            const option = document.createElement('option');
            option.value = rider;
            option.textContent = rider;
            riderSelect.appendChild(option);
        });

        rings.forEach(ring => {
            const option = document.createElement('option');
            option.value = ring;
            option.textContent = ring;
            ringSelect.appendChild(option);
        });
    }

    // Show tab with URL updating
    function showTab(tabName) {
        // Hide all tabs
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.style.display = 'none';
        });

        // Remove active class from all tabs
        document.querySelectorAll('.tab').forEach(tab => {
            tab.classList.remove('active');
        });

        // Show selected tab
        document.getElementById(tabName + '-tab').style.display = 'block';

        // Find and activate the correct tab button
        const tabs = document.querySelectorAll('.tab');
        const tabIndex = {'schedule': 0, 'riders': 1, 'rings': 2, 'days': 3}[tabName];
        if (tabs[tabIndex]) {
            tabs[tabIndex].classList.add('active');
        }

        currentTab = tabName;

        // Update URL only for tab change (preserve existing filters)
        const params = getUrlParameters();
        params.tab = tabName;
        if (tabName === 'schedule') {
            // Clear filters when going to schedule tab
            delete params.rider;
            delete params.day;
            delete params.ring;
        }
        updateUrl(params);

        // Load appropriate content
        switch(tabName) {
            case 'schedule':
                showFullSchedule();
                break;
            case 'riders':
                if (!params.rider) {
                    document.getElementById('rider-schedule').innerHTML = '<div class="no-data">Sélectionnez un cavalier</div>';
                }
                break;
            case 'rings':
                if (!params.ring) {
                    document.getElementById('ring-schedule').innerHTML = '<div class="no-data">Sélectionnez un ring</div>';
                }
                break;
            case 'days':
                if (!params.day) {
                    showFullSchedule();
                    document.getElementById('day-schedule').innerHTML = document.getElementById('full-schedule').innerHTML;
                }
                break;
        }
    }

    // Create schedule table - WITH INLINE STYLES FOR COLORS
    function createScheduleTable(data) {
        if (data.length === 0) {
            return '<div class="no-data">Aucune donnée à afficher</div>';
        }

        let html = `
                <table class="schedule-table">
                    <thead>
                        <tr>
                            <th>Heure</th>
                            <th>Cavalier</th>
                            <th>Classe</th>
                            <th>Ring</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

        data.forEach(item => {
            const ringColor = getRingColor(item.ring);
            console.log(`INLINE STYLE: Ring "${item.ring}" -> Color "${ringColor}"`);

            html += `
                    <tr>
                        <td class="time-column">${item.time}</td>
                        <td class="rider-column"><a href="#" class="rider-link" onclick="handleRiderClick('${item.rider_name.replace(/'/g, "\\'")}')"; return false;">${item.rider_name}</a></td>
                        <td class="class-column">${item.class}</td>
                        <td style="background-color: ${ringColor}; color: white; text-align: center; border-radius: 3px; font-weight: bold; padding: 4px 8px;"><a href="#" class="ring-link" onclick="handleRingClick('${item.ring.replace(/'/g, "\\'")}')"; return false;">${item.ring}</a></td>
                    </tr>
                `;
        });

        html += '</tbody></table>';
        return html;
    }

    // Show full schedule by day
    function showFullSchedule() {
        const container = document.getElementById('full-schedule');
        const days = ['vendredi', 'samedi', 'dimanche'];
        let html = '';

        days.forEach(day => {
            const dayData = scheduleData.filter(item => item.day.toLowerCase() === day);
            if (dayData.length > 0) {
                html += `
                        <div class="day-section">
                            <div class="day-header">${day.charAt(0).toUpperCase() + day.slice(1)}</div>
                            ${createScheduleTable(dayData)}
                        </div>
                    `;
            }
        });

        container.innerHTML = html || '<div class="no-data">Aucune donnée disponible</div>';
    }


    // Filter by ring with URL updating
    function filterByRing() {
        const selectedRing = document.getElementById('ring-filter').value;
        const container = document.getElementById('ring-schedule');

        // Update URL
        updateUrl({ tab: 'rings', ring: selectedRing });

        if (!selectedRing) {
            container.innerHTML = '<div class="no-data">Sélectionnez un ring</div>';
            return;
        }

        const ringData = scheduleData.filter(item => item.ring === selectedRing);
        const days = ['vendredi', 'samedi', 'dimanche'];
        let html = '';

        days.forEach(day => {
            const dayData = ringData.filter(item => item.day.toLowerCase() === day);
            if (dayData.length > 0) {
                html += `
                        <div class="day-section">
                            <div class="day-header">${day.charAt(0).toUpperCase() + day.slice(1)} - ${selectedRing}</div>
                            ${createScheduleTable(dayData)}
                        </div>
                    `;
            }
        });

        container.innerHTML = html || '<div class="no-data">Aucune compétition pour ce ring</div>';
    }


    // Initialize
    document.addEventListener('DOMContentLoaded', loadSchedule);
</script>
</body>
</html>